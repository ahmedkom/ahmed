<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†Ø¨Ù‡ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ù†Ø§Ø·Ù‚</title>
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <meta name="theme-color" content="#ee7752">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Ù…Ù†Ø¨Ù‡ Ø¯ÙˆØ§Ø¡","short_name":"Ø¯ÙˆØ§Ø¡","start_url":".","display":"standalone","theme_color":"#ee7752","background_color":"#ee7752","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/822/822163.png","sizes":"192x192","type":"image/png"}]}'>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00f260;
            --secondary: #0575e6;
            --glass: rgba(255, 255, 255, 0.15);
            --glass-strong: rgba(0, 0, 0, 0.3);
            --border: rgba(255, 255, 255, 0.2);
            --text: #ffffff;
            --danger: #ff416c;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 90%;
            max-width: 450px;
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            scrollbar-width: none;
        }
        .container::-webkit-scrollbar { display: none; }

        h1, h2 { text-align: center; margin: 0 0 20px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        h1 { font-weight: 800; letter-spacing: 1px; font-size: 24px; }
        h2 { font-size: 16px; font-weight: 300; opacity: 0.9; }

        .step { display: none; animation: fadeIn 0.5s ease; }
        .step.active { display: block; }

        .input-group { position: relative; margin-bottom: 25px; }

        input, select {
            width: 100%; padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: #fff; font-size: 18px; font-family: 'Tajawal', sans-serif;
            outline: none; box-sizing: border-box;
            transition: 0.3s; text-align: center; appearance: none;
        }

        .time-select-container { display: flex; gap: 10px; justify-content: center; }
        .time-select-container select { width: 32%; padding: 10px; font-size: 16px; background: rgba(0,0,0,0.3); cursor: pointer; }
        .time-select-container select option { background: #333; color: #fff; }

        input:focus, select:focus { background: rgba(0, 0, 0, 0.4); border-color: var(--primary); }

        button {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            font-size: 18px; font-weight: bold; font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            color: white; margin-bottom: 10px;
            transition: transform 0.2s;
        }
        button:active { transform: scale(0.96); }

        .btn-danger { background: linear-gradient(90deg, #ff416c, #ff4b2b); }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.3); }
        .btn-add-new { background: rgba(255,255,255,0.2); border: 1px dashed rgba(255,255,255,0.5); margin-top: 15px; }

        .icon-header {
            font-size: 50px; display: block; text-align: center; margin-bottom: 15px;
            background: -webkit-linear-gradient(#eee, #333); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø³ØªØ§ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
        .med-item {
            background: var(--glass-strong);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border-right: 5px solid var(--primary);
            position: relative;
            animation: fadeIn 0.5s ease;
        }
        .med-item h3 { margin: 0; font-size: 20px; color: var(--primary); }
        .med-timer { font-size: 28px; font-weight: bold; margin: 10px 0; font-family: monospace; direction: ltr; }
        .med-details { font-size: 14px; opacity: 0.8; display: flex; justify-content: space-between; }
        .med-actions { display: flex; gap: 10px; margin-top: 10px; }
        .med-actions button { padding: 8px; font-size: 14px; margin: 0; }
        
        #alarmModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; backdrop-filter: blur(10px);
        }
        .bell-animation { font-size: 80px; color: var(--danger); animation: ring 0.5s infinite; margin-bottom: 20px; }
        @keyframes ring { 0% { transform: rotate(0); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } 100% { transform: rotate(0); } }
    </style>
</head>
<body>

    <div class="container" id="mainCard">
        
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© / Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© -->
        <div id="dashboard" class="step">
            <i class="fas fa-heartbeat icon-header" style="-webkit-text-fill-color: var(--primary);"></i>
            <h1>Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯ÙˆÙŠØªÙŠ</h1>
            <div id="medListContainer">
                <div style="text-align: center; opacity: 0.7; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ©.. Ø£Ø¶Ù Ø£ÙˆÙ„ Ø¯ÙˆØ§Ø¡</div>
            </div>
            <button class="btn-add-new" onclick="startNewMedFlow()">+ Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1 -->
        <div id="step1" class="step">
            <i class="fas fa-pills icon-header" style="-webkit-text-fill-color: var(--primary);"></i>
            <h1>Ù…Ø§ Ù‡Ùˆ Ø¯ÙˆØ§Ø¤ÙƒØŸ</h1>
            <h2>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h2>
            <div class="input-group">
                <input type="text" id="medicineName" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù†Ø§Ø¯ÙˆÙ„..." autocomplete="off">
            </div>
            <button onclick="nextStep(1)">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
            <button class="btn-outline" onclick="goToDashboard()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>

        <!-- Ø§Ù„Ø®Ø·ÙˆØ© 2 -->
        <div id="step2" class="step">
            <i class="fas fa-clock icon-header" style="-webkit-text-fill-color: var(--secondary);"></i>
            <h1>Ù…ØªÙ‰ Ø§Ù„Ù…ÙˆØ¹Ø¯ØŸ</h1>
            <div class="input-group time-select-container">
                <select id="timeHour"><option value="" disabled selected>Ø³</option><script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script></select>
                <select id="timeMinute"><option value="" disabled selected>Ø¯</option><script>for(let i=0; i<60; i++) {let m=i<10?'0'+i:i; document.write(`<option value="${m}">${m}</option>`);}</script></select>
                <select id="timePeriod"><option value="AM">ØµØ¨Ø§Ø­Ø§Ù‹</option><option value="PM">Ù…Ø³Ø§Ø¡Ù‹</option></select>
            </div>
            <button onclick="nextStep(2)">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
        </div>

        <!-- Ø§Ù„Ø®Ø·ÙˆØ© 3 -->
        <div id="step3" class="step">
            <i class="fas fa-sort-numeric-down icon-header" style="-webkit-text-fill-color: #ff9966;"></i>
            <h1>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØŸ</h1>
            <div class="input-group">
                <input type="number" id="remainingDoses" placeholder="ÙƒÙ… Ø­Ø¨Ø© Ù…ØªØ¨Ù‚ÙŠØ©ØŸ" min="1">
            </div>
            <button onclick="saveMedication()">Ø­ÙØ¸ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ âœ…</button>
        </div>

    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ù†ÙŠÙ† -->
    <div id="alarmModal">
        <i class="fas fa-bell bell-animation"></i>
        <h1 style="font-size: 32px; margin-bottom: 10px;">ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ø¡!</h1>
        <h2 id="modalMedName" style="font-size: 30px; color: var(--primary); font-weight: bold;"></h2>
        <button onclick="takeDoseFromModal()" style="max-width: 250px; margin-top: 20px;">âœ… ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø¯ÙˆØ§Ø¡</button>
        <button onclick="snoozeAlarm()" class="btn-outline" style="max-width: 250px;">â° ØºÙÙˆØ© 5 Ø¯Ù‚Ø§Ø¦Ù‚</button>
    </div>

    <script>
        // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
        let medications = [];
        let tempMed = {}; 
        let activeAlarmMedId = null;
        let speechInterval = null; // Ù…ØªØºÙŠØ± Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙ„Ø§Ù…

        document.addEventListener('DOMContentLoaded', () => {
            // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±Ø§Ù‹
            if ("Notification" in window) {
                Notification.requestPermission();
            }

            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const savedMeds = localStorage.getItem('myMedications');
            if (savedMeds) {
                medications = JSON.parse(savedMeds);
            }

            if (medications.length > 0) {
                goToDashboard();
            } else {
                startNewMedFlow();
            }

            setInterval(checkAlarms, 1000);
            
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', e => self.skipWaiting());
                    self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
                    self.addEventListener('fetch', e => {}); 
                `;
                const blob = new Blob([swCode], {type: 'text/javascript'});
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).catch(console.error);
            }
        });

        // --- Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª ---
        function showStep(id) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startNewMedFlow() {
            tempMed = {};
            document.getElementById('medicineName').value = '';
            document.getElementById('remainingDoses').value = '';
            showStep('step1');
        }

        function goToDashboard() {
            renderMedList();
            showStep('dashboard');
        }

        function nextStep(current) {
            if (current === 1) {
                const name = document.getElementById('medicineName').value;
                if (!name) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…");
                tempMed.name = name;
                showStep('step2');
            } else if (current === 2) {
                const h = document.getElementById('timeHour').value;
                const m = document.getElementById('timeMinute').value;
                const p = document.getElementById('timePeriod').value;
                if (!h || !m) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆÙ‚Øª");
                
                let h24 = parseInt(h);
                if (p === 'PM' && h24 < 12) h24 += 12;
                if (p === 'AM' && h24 === 12) h24 = 0;
                
                tempMed.time = `${h24.toString().padStart(2,'0')}:${m}`;
                tempMed.displayTime = `${h}:${m} ${p === 'AM' ? 'Øµ' : 'Ù…'}`;
                showStep('step3');
            }
        }

        function saveMedication() {
            const doses = document.getElementById('remainingDoses').value;
            if (!doses) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯");
            
            tempMed.doses = parseInt(doses);
            tempMed.id = Date.now();
            tempMed.lastTaken = null; 

            medications.push(tempMed);
            localStorage.setItem('myMedications', JSON.stringify(medications));
            
            goToDashboard();
        }

        function renderMedList() {
            const container = document.getElementById('medListContainer');
            if (medications.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ©.. Ø£Ø¶Ù Ø£ÙˆÙ„ Ø¯ÙˆØ§Ø¡</div>';
                return;
            }

            container.innerHTML = '';
            medications.forEach(med => {
                const div = document.createElement('div');
                div.className = 'med-item';
                div.id = `med-${med.id}`;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>${med.name}</h3>
                        <span style="background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:10px; font-size:12px">${med.displayTime}</span>
                    </div>
                    <div class="med-timer" id="timer-${med.id}">--:--:--</div>
                    <div class="med-details">
                        <span>Ù…ØªØ¨Ù‚ÙŠ: <b>${med.doses}</b></span>
                    </div>
                    <div class="med-actions">
                        <button onclick="takeDose(${med.id})"><i class="fas fa-check"></i> Ø£Ø®Ø°Øª Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
                        <button class="btn-danger" style="width:auto" onclick="deleteMed(${med.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function checkAlarms() {
            const now = new Date();
            const currentSec = Math.floor(now.getTime() / 1000);

            medications.forEach(med => {
                const [h, m] = med.time.split(':');
                let target = new Date();
                target.setHours(h, m, 0, 0);
                
                if (target <= now) target.setDate(target.getDate() + 1);
                
                const diff = target - now;
                
                const timerEl = document.getElementById(`timer-${med.id}`);
                if (timerEl) {
                    const hh = Math.floor((diff / (1000 * 60 * 60)) % 24);
                    const mm = Math.floor((diff / (1000 * 60)) % 60);
                    const ss = Math.floor((diff / 1000) % 60);
                    timerEl.innerText = `${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
                }

                const alarmKey = `alarm_${med.id}_${now.getDate()}_${now.getHours()}:${now.getMinutes()}`;
                const nowStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                
                if (nowStr === med.time && !localStorage.getItem(alarmKey)) {
                    triggerAlarm(med);
                    localStorage.setItem(alarmKey, 'fired');
                }
            });
        }

        // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†Ø§Ø·Ù‚ (Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
        function triggerAlarm(med) {
            activeAlarmMedId = med.id;
            document.getElementById('modalMedName').innerText = med.name;
            document.getElementById('alarmModal').style.display = 'flex';
            
            if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);

            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ
            speakMedicationName(med.name);

            if (Notification.permission === "granted") {
                new Notification(`ğŸ’Š ÙˆÙ‚Øª Ø¯ÙˆØ§Ø¡: ${med.name}`, { body: 'ÙŠØ±Ø¬Ù‰ Ø£Ø®Ø° Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ø¢Ù†' });
            }
        }

        function speakMedicationName(medName) {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ÙƒÙ„Ø§Ù… Ø³Ø§Ø¨Ù‚
            window.speechSynthesis.cancel();

            const msg = new SpeechSynthesisUtterance();
            msg.text = `ØªÙ†Ø¨ÙŠÙ‡.. Ø­Ø§Ù† Ù…ÙˆØ¹Ø¯ Ø¯ÙˆØ§Ø¡ ${medName}.. ÙŠØ±Ø¬Ù‰ Ø£Ø®Ø° Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ø¢Ù†`;
            msg.lang = 'ar-SA'; // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            msg.rate = 0.9; // Ø³Ø±Ø¹Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
            msg.volume = 1; // Ø£Ø¹Ù„Ù‰ ØµÙˆØª

            // Ù†Ø·Ù‚ Ø§Ù„Ø¬Ù…Ù„Ø© ÙÙˆØ±Ø§Ù‹
            window.speechSynthesis.speak(msg);

            // ØªÙƒØ±Ø§Ø± Ø§Ù„Ù†Ø·Ù‚ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ Ø­ØªÙ‰ ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†Ø¨Ù‡
            if (speechInterval) clearInterval(speechInterval);
            speechInterval = setInterval(() => {
                if (!window.speechSynthesis.speaking) {
                    window.speechSynthesis.speak(msg);
                }
            }, 5000);
        }

        function stopSpeaking() {
            if (speechInterval) clearInterval(speechInterval);
            window.speechSynthesis.cancel();
        }

        // --- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ---
        function takeDose(id) {
            const index = medications.findIndex(m => m.id === id);
            if (index > -1) {
                if (medications[index].doses > 0) {
                    medications[index].doses--;
                    localStorage.setItem('myMedications', JSON.stringify(medications));
                    renderMedList();
                    if(activeAlarmMedId === id) stopAlarmUI();
                } else {
                    alert("Ù„Ù‚Ø¯ Ù†ÙØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡!");
                }
            }
        }

        function takeDoseFromModal() {
            if (activeAlarmMedId) takeDose(activeAlarmMedId);
            stopAlarmUI();
        }

        function stopAlarmUI() {
            document.getElementById('alarmModal').style.display = 'none';
            stopSpeaking(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª
            activeAlarmMedId = null;
        }

        function snoozeAlarm() {
            stopAlarmUI();
            alert("ØªÙ… ØªØ£Ø¬ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ 5 Ø¯Ù‚Ø§Ø¦Ù‚");
        }

        function deleteMed(id) {
            if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                medications = medications.filter(m => m.id !== id);
                localStorage.setItem('myMedications', JSON.stringify(medications));
                renderMedList();
            }
        }
    </script>
</body>
      </html>
